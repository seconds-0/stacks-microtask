<!DOCTYPE html>
<html>
<head>
    <title>Micro-Task Board - Stacks Testnet</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .task {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .available { background-color: #f8f9fa; }
        .claimed { background-color: #fff3cd; }
        .completed { background-color: #d4edda; }
        .status-bar {
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .hidden { display: none; }
        .flex-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        #post-task-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #post-task-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .loader {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 6px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tx-link {
            font-size: 12px;
            margin-left: 10px;
            color: #007bff;
            text-decoration: none;
        }
        .tx-link:hover {
            text-decoration: underline;
        }
    </style>
    <!-- Include Stacks.js libraries -->
    <script src="https://unpkg.com/@stacks/connect@latest/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@stacks/transactions@latest/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@stacks/network@latest/dist/index.umd.js"></script>
</head>
<body>
    <h1>Micro-Task Board - Stacks Testnet</h1>
    
    <div id="status-message" class="status-bar">Connect your Hiro Wallet to interact with the Micro-Task Board on Stacks Testnet</div>
    
    <div id="wallet-section">
        <button id="connect-wallet">Connect Wallet</button>
        <div id="wallet-info"></div>
    </div>

    <div id="post-task-section" class="hidden">
        <h2>Post New Task</h2>
        <form id="post-task-form">
            <input type="text" id="task-description" maxlength="256" placeholder="Task description" required>
            <input type="number" id="task-reward" placeholder="Reward (in STX)" min="1" required>
            <button type="submit" id="post-task-btn">Post Task</button>
        </form>
    </div>

    <div id="task-list-section">
        <h2>Available Tasks</h2>
        <div id="task-list">
            <!-- Tasks will be loaded here -->
            <p id="no-tasks">No tasks found. Connect your wallet to view or create tasks.</p>
        </div>
    </div>

    <script>
        // Stacks Testnet configuration
        const { StacksTestnet } = window.StacksNetwork;
        const network = new StacksTestnet();
        
        // Contract details
        // Note: Replace with your actual deployed contract address
        const contractAddress = 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM';
        const contractName = 'microtasks';

        // Connect functionality from Stacks.js
        const { openConnect, openSTXTransfer, UserSession, AppConfig } = window.StacksConnect;
        const { standardPrincipalCV, stringUtf8CV, uintCV, cvToValue, callReadOnlyFunction, makeContractCall, broadcastTransaction } = window.StacksTransactions;

        // App state
        let userAddress = null;
        let userSession = null;
        let allTasks = []; // All tasks from the network
        
        // DOM elements
        const connectBtn = document.getElementById('connect-wallet');
        const walletInfo = document.getElementById('wallet-info');
        const postTaskSection = document.getElementById('post-task-section');
        const postTaskForm = document.getElementById('post-task-form');
        const taskListEl = document.getElementById('task-list');
        const noTasksEl = document.getElementById('no-tasks');
        const statusMessage = document.getElementById('status-message');

        // Initialize Stacks Connect
        const appConfig = new AppConfig(['store_write', 'publish_data']);
        userSession = new UserSession({ appConfig });

        // Check if user is already signed in
        if (userSession.isUserSignedIn()) {
            const userData = userSession.loadUserData();
            userAddress = userData.profile.stxAddress.testnet;
            showMessage('Connected to Stacks Testnet', 'success');
            updateUI();
            loadTasks();
        }

        // Helper functions
        function showMessage(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = `status-bar ${type}`;
        }

        function formatSTX(ustx) {
            return (parseInt(ustx) / 1000000).toFixed(6) + ' STX';
        }

        function shortenAddress(address) {
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }

        function getExplorerTxUrl(txId) {
            return `https://explorer.stacks.co/txid/${txId}?chain=testnet`;
        }

        // Connect wallet with Stacks Connect
        connectBtn.addEventListener('click', async () => {
            showConnect();
        });

        function showConnect() {
            openConnect({
                appDetails: {
                    name: 'Micro-Task Board',
                    icon: window.location.origin + '/icon.png',
                },
                redirectTo: '/',
                onFinish: () => {
                    const userData = userSession.loadUserData();
                    userAddress = userData.profile.stxAddress.testnet;
                    showMessage('Connected to Stacks Testnet', 'success');
                    updateUI();
                    loadTasks();
                },
                userSession,
            });
        }

        // Post a new task
        postTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const description = document.getElementById('task-description').value;
            const rewardStx = parseFloat(document.getElementById('task-reward').value);
            
            if (!description || isNaN(rewardStx) || rewardStx <= 0) {
                showMessage('Please provide a valid description and reward amount.', 'error');
                return;
            }

            // Convert STX to microSTX
            const rewardMicroStx = rewardStx * 1000000;
            
            // Disable form during transaction
            const submitButton = document.getElementById('post-task-btn');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.innerHTML = originalButtonText + ' <span class="loader"></span>';
            
            try {
                showMessage('Preparing to post task...', 'success');
                
                const functionArgs = [
                    stringUtf8CV(description),
                    uintCV(rewardMicroStx)
                ];
                
                const options = {
                    contractAddress,
                    contractName,
                    functionName: 'post-task',
                    functionArgs,
                    network,
                    appDetails: {
                        name: 'Micro-Task Board',
                        icon: window.location.origin + '/icon.png',
                    },
                    onFinish: data => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                        
                        // Clear form
                        document.getElementById('task-description').value = '';
                        document.getElementById('task-reward').value = '';
                        
                        const txLink = getExplorerTxUrl(data.txId);
                        showMessage(`Task posted! Transaction ID: ${data.txId.substr(0, 10)}...`, 'success');
                        
                        // Add link to status message
                        statusMessage.innerHTML += ` <a href="${txLink}" target="_blank" class="tx-link">View transaction</a>`;
                        
                        // Reload tasks after a delay to allow for confirmation
                        setTimeout(loadTasks, 3000);
                    }
                };
                
                await openSTXTransfer(options);
                
            } catch (e) {
                console.error('Error posting task:', e);
                showMessage('Error posting task: ' + e.message, 'error');
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Claim a task
        async function claimTask(taskId, poster) {
            if (!userAddress) {
                showMessage('Please connect your wallet first.', 'error');
                return;
            }
            
            try {
                showMessage('Preparing to claim task...', 'success');
                
                const functionArgs = [
                    uintCV(taskId),
                    standardPrincipalCV(poster)
                ];
                
                const options = {
                    contractAddress,
                    contractName,
                    functionName: 'claim-task',
                    functionArgs,
                    network,
                    appDetails: {
                        name: 'Micro-Task Board',
                        icon: window.location.origin + '/icon.png',
                    },
                    onFinish: data => {
                        const txLink = getExplorerTxUrl(data.txId);
                        showMessage(`Task claimed! Transaction ID: ${data.txId.substr(0, 10)}...`, 'success');
                        statusMessage.innerHTML += ` <a href="${txLink}" target="_blank" class="tx-link">View transaction</a>`;
                        
                        // Reload tasks after a delay to allow for confirmation
                        setTimeout(loadTasks, 3000);
                    }
                };
                
                await makeContractCall(options);
                
            } catch (e) {
                console.error('Error claiming task:', e);
                showMessage('Error claiming task: ' + e.message, 'error');
            }
        }

        // Approve a task
        async function approveTask(taskId) {
            if (!userAddress) {
                showMessage('Please connect your wallet first.', 'error');
                return;
            }
            
            try {
                showMessage('Preparing to approve task...', 'success');
                
                const functionArgs = [
                    uintCV(taskId)
                ];
                
                const options = {
                    contractAddress,
                    contractName,
                    functionName: 'approve-task',
                    functionArgs,
                    network,
                    appDetails: {
                        name: 'Micro-Task Board',
                        icon: window.location.origin + '/icon.png',
                    },
                    onFinish: data => {
                        const txLink = getExplorerTxUrl(data.txId);
                        showMessage(`Task approved! Transaction ID: ${data.txId.substr(0, 10)}...`, 'success');
                        statusMessage.innerHTML += ` <a href="${txLink}" target="_blank" class="tx-link">View transaction</a>`;
                        
                        // Reload tasks after a delay to allow for confirmation
                        setTimeout(loadTasks, 3000);
                    }
                };
                
                await makeContractCall(options);
                
            } catch (e) {
                console.error('Error approving task:', e);
                showMessage('Error approving task: ' + e.message, 'error');
            }
        }

        // Load and display tasks from the contract
        async function loadTasks() {
            if (!userAddress) return;
            
            showMessage('Loading tasks...', 'success');
            
            try {
                const readOnlyResponse = await callReadOnlyFunction({
                    contractAddress,
                    contractName,
                    functionName: 'get-all-tasks',
                    functionArgs: [],
                    network,
                    senderAddress: userAddress,
                });
                
                // Parse the response from the contract
                const result = cvToValue(readOnlyResponse);
                
                if (result && Array.isArray(result) && result.length > 0) {
                    allTasks = result.map((task, index) => {
                        // Parse task data from contract format
                        return {
                            id: task.value['task-id'].value,
                            description: task.value.description.value,
                            reward: task.value.reward.value,
                            poster: task.value.poster.value,
                            claimer: task.value.claimer.value || null,
                            completed: task.value.completed.value,
                            status: task.value.status.value
                        };
                    }).filter(t => t !== null);
                    
                    renderTasks();
                    showMessage('Tasks loaded successfully!', 'success');
                } else {
                    allTasks = [];
                    noTasksEl.style.display = 'block';
                    taskListEl.innerHTML = '';
                    showMessage('No tasks found.', 'success');
                }
            } catch (e) {
                console.error('Error loading tasks:', e);
                showMessage('Error loading tasks: ' + e.message, 'error');
                
                // Use sample tasks for demo if real tasks can't be loaded
                simulateTaskLoad();
                renderTasks();
            }
        }
        
        // Render tasks in UI
        function renderTasks() {
            if (allTasks.length === 0) {
                noTasksEl.style.display = 'block';
                taskListEl.innerHTML = '';
                return;
            }
            
            noTasksEl.style.display = 'none';
            taskListEl.innerHTML = '';
            
            allTasks.forEach(task => {
                const taskEl = document.createElement('div');
                const statusClass = task.completed ? 'completed' : (task.claimer ? 'claimed' : 'available');
                taskEl.className = `task ${statusClass}`;
                
                const isUserTask = task.poster === userAddress;
                const isUserClaimer = task.claimer === userAddress;
                
                let actionBtn = '';
                if (!task.completed) {
                    if (!task.claimer && !isUserTask) {
                        actionBtn = `<button onclick="claimTask(${task.id}, '${task.poster}')">Claim Task</button>`;
                    } else if (isUserTask && task.claimer) {
                        actionBtn = `<button onclick="approveTask(${task.id})">Approve & Pay</button>`;
                    }
                }
                
                let status = 'Available';
                if (task.completed) status = 'Completed';
                else if (task.claimer) status = 'Claimed';
                
                taskEl.innerHTML = `
                    <h3>${task.description}</h3>
                    <p><strong>Reward:</strong> ${formatSTX(task.reward)}</p>
                    <p><strong>Status:</strong> ${status}</p>
                    <p><strong>Posted by:</strong> ${shortenAddress(task.poster)}</p>
                    ${task.claimer ? `<p><strong>Claimed by:</strong> ${shortenAddress(task.claimer)}</p>` : ''}
                    ${actionBtn}
                `;
                
                taskListEl.appendChild(taskEl);
            });
        }

        // Update UI based on wallet connection
        function updateUI() {
            if (userAddress) {
                connectBtn.style.display = 'none';
                walletInfo.innerHTML = `<p>Connected: ${shortenAddress(userAddress)}</p>`;
                postTaskSection.classList.remove('hidden');
            } else {
                connectBtn.style.display = 'block';
                walletInfo.innerHTML = '';
                postTaskSection.classList.add('hidden');
            }
        }

        // Fallback: Simulate task data if blockchain connection fails
        function simulateTaskLoad() {
            console.log("Using simulated task data as fallback");
            allTasks = [
                {
                    id: 0,
                    description: 'Create a logo for my project',
                    reward: 5000000, // 5 STX
                    poster: userAddress || 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM',
                    claimer: null,
                    completed: false,
                    status: "open"
                },
                {
                    id: 1,
                    description: 'Write test cases for smart contract',
                    reward: 10000000, // 10 STX
                    poster: userAddress || 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM',
                    claimer: 'ST2CY5V39NHDPWSXMW9QDT3HC3GD6Q6XX4CFRK9AG',
                    completed: false,
                    status: "claimed"
                },
                {
                    id: 2,
                    description: 'Fix CSS layout issues',
                    reward: 3000000, // 3 STX
                    poster: 'ST2CY5V39NHDPWSXMW9QDT3HC3GD6Q6XX4CFRK9AG',
                    claimer: userAddress || 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM',
                    completed: true,
                    status: "completed"
                }
            ];
            
            // Show message that we're using simulated data
            showMessage('Using simulated task data (Testnet connection failed)', 'error');
        }
        
        // Expose functions to be called from HTML
        window.claimTask = claimTask;
        window.approveTask = approveTask;
    </script>
</body>
</html>